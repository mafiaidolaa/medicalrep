-- =====================================================
-- Migration: Add Security & Integrity Features
-- =====================================================
-- Date: 2024
-- Description: ุฅุถุงูุฉ ุงูุญูุงูุฉ ูุงูุชุญุณููุงุช ุงูุฃูููุฉ ูููุธุงู
-- =====================================================

-- ========================================
-- PART 0: Drop Existing Views (ุฅุฐุง ููุฌูุฏุฉ)
-- ========================================
-- ูุฌุจ ุญุฐู ุงูู Views ูุจู ุชุนุฏูู ุงูุฃุนูุฏุฉ

DROP VIEW IF EXISTS low_stock_products CASCADE;
DROP VIEW IF EXISTS order_summary CASCADE;
DROP VIEW IF EXISTS clinic_orders CASCADE;
DROP VIEW IF EXISTS product_stock_status CASCADE;

-- ========================================
-- PART 1: Add Version Control (ููุญูุงูุฉ ูู Race Conditions)
-- ========================================

-- ุฅุถุงูุฉ ุนููุฏ version ููุฌุฏุงูู ุงููููุฉ
ALTER TABLE orders ADD COLUMN IF NOT EXISTS version INTEGER DEFAULT 1;
ALTER TABLE products ADD COLUMN IF NOT EXISTS version INTEGER DEFAULT 1;
ALTER TABLE clinics ADD COLUMN IF NOT EXISTS version INTEGER DEFAULT 1;
ALTER TABLE visits ADD COLUMN IF NOT EXISTS version INTEGER DEFAULT 1;

-- ุฅุถุงูุฉ trigger ูุชุญุฏูุซ version ุชููุงุฆูุงู
CREATE OR REPLACE FUNCTION increment_version()
RETURNS TRIGGER AS $$
BEGIN
  NEW.version = OLD.version + 1;
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ุฑุจุท ุงูู trigger ุจุงูุฌุฏุงูู
DROP TRIGGER IF EXISTS orders_version_trigger ON orders;
CREATE TRIGGER orders_version_trigger
  BEFORE UPDATE ON orders
  FOR EACH ROW
  EXECUTE FUNCTION increment_version();

DROP TRIGGER IF EXISTS products_version_trigger ON products;
CREATE TRIGGER products_version_trigger
  BEFORE UPDATE ON products
  FOR EACH ROW
  EXECUTE FUNCTION increment_version();

DROP TRIGGER IF EXISTS clinics_version_trigger ON clinics;
CREATE TRIGGER clinics_version_trigger
  BEFORE UPDATE ON clinics
  FOR EACH ROW
  EXECUTE FUNCTION increment_version();

DROP TRIGGER IF EXISTS visits_version_trigger ON visits;
CREATE TRIGGER visits_version_trigger
  BEFORE UPDATE ON visits
  FOR EACH ROW
  EXECUTE FUNCTION increment_version();

-- ========================================
-- PART 2: Add Stock Management Features
-- ========================================

-- ุฅุถุงูุฉ min_stock_level ููุชุญุฐูุฑุงุช
ALTER TABLE products ADD COLUMN IF NOT EXISTS min_stock_level INTEGER DEFAULT 10;

-- ุงูุชุฃูุฏ ูู ูุฌูุฏ constraints ุตุญูุญุฉ
ALTER TABLE products 
  DROP CONSTRAINT IF EXISTS products_stock_non_negative;
  
ALTER TABLE products 
  ADD CONSTRAINT products_stock_non_negative 
  CHECK (stock >= 0);

-- ========================================
-- PART 3: Safe Stock Decrement Function
-- ========================================

-- ุฏุงูุฉ ุขููุฉ ูุฎุตู ุงููุฎุฒูู (atomic operation)
CREATE OR REPLACE FUNCTION decrement_stock(
  p_product_id UUID,
  p_quantity INTEGER
) RETURNS TABLE(
  success BOOLEAN,
  new_stock INTEGER,
  message TEXT
) AS $$
DECLARE
  v_current_stock INTEGER;
  v_product_name TEXT;
BEGIN
  -- ููู ุงูุตู ูููุฑุงุกุฉ ูุงูุชุนุฏูู (ููุน race conditions)
  SELECT stock, name INTO v_current_stock, v_product_name
  FROM products
  WHERE id = p_product_id
  FOR UPDATE;  -- ๐ Lock ุญุชู ููุงูุฉ ุงูู transaction

  -- ุงูุชุญูู ูู ูุฌูุฏ ุงูููุชุฌ
  IF NOT FOUND THEN
    RETURN QUERY SELECT 
      FALSE, 
      0, 
      'ุงูููุชุฌ ุบูุฑ ููุฌูุฏ';
    RETURN;
  END IF;

  -- ุงูุชุญูู ูู ููุงูุฉ ุงููุฎุฒูู
  IF v_current_stock < p_quantity THEN
    RETURN QUERY SELECT 
      FALSE, 
      v_current_stock,
      format('ูุฎุฒูู ุบูุฑ ูุงูู: %s - ูุชููุฑ: %sุ ูุทููุจ: %s', 
             v_product_name, v_current_stock, p_quantity);
    RETURN;
  END IF;

  -- ุฎุตู ุงููุฎุฒูู
  UPDATE products
  SET 
    stock = stock - p_quantity,
    updated_at = NOW()
  WHERE id = p_product_id;

  -- ุฅุฑุฌุงุน ุงููุชูุฌุฉ
  RETURN QUERY SELECT 
    TRUE, 
    v_current_stock - p_quantity,
    'ุชู ุฎุตู ุงููุฎุฒูู ุจูุฌุงุญ';
END;
$$ LANGUAGE plpgsql;

-- ========================================
-- PART 4: Safe Stock Increment Function
-- ========================================

-- ุฏุงูุฉ ุขููุฉ ูุฅุถุงูุฉ ูููุฎุฒูู (ุนูุฏ ุงูุฅุฑุฌุงุน ุฃู ุงูุฅุถุงูุฉ)
CREATE OR REPLACE FUNCTION increment_stock(
  p_product_id UUID,
  p_quantity INTEGER
) RETURNS TABLE(
  success BOOLEAN,
  new_stock INTEGER,
  message TEXT
) AS $$
DECLARE
  v_new_stock INTEGER;
BEGIN
  -- ุชุญุฏูุซ ุงููุฎุฒูู
  UPDATE products
  SET 
    stock = stock + p_quantity,
    updated_at = NOW()
  WHERE id = p_product_id
  RETURNING stock INTO v_new_stock;

  -- ุงูุชุญูู ูู ุงููุฌุงุญ
  IF NOT FOUND THEN
    RETURN QUERY SELECT 
      FALSE, 
      0, 
      'ุงูููุชุฌ ุบูุฑ ููุฌูุฏ';
    RETURN;
  END IF;

  -- ุฅุฑุฌุงุน ุงููุชูุฌุฉ
  RETURN QUERY SELECT 
    TRUE, 
    v_new_stock,
    'ุชู ุฅุถุงูุฉ ูููุฎุฒูู ุจูุฌุงุญ';
END;
$$ LANGUAGE plpgsql;

-- ========================================
-- PART 5: Stock History Tracking
-- ========================================

-- ุฌุฏูู ูุชุชุจุน ุญุฑูุฉ ุงููุฎุฒูู (audit trail)
CREATE TABLE IF NOT EXISTS stock_movements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  quantity_change INTEGER NOT NULL, -- ุณุงูุจ ููุฎุตูุ ููุฌุจ ููุฅุถุงูุฉ
  reason TEXT NOT NULL, -- 'order', 'return', 'adjustment', 'initial'
  reference_id UUID, -- order_id ุฃู visit_id
  performed_by UUID REFERENCES users(id),
  old_stock INTEGER NOT NULL,
  new_stock INTEGER NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  notes TEXT
);

-- Index ููุฃุฏุงุก
CREATE INDEX IF NOT EXISTS idx_stock_movements_product 
  ON stock_movements(product_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_stock_movements_reference 
  ON stock_movements(reference_id);

-- Trigger ูุชุณุฌูู ูู ุชุบููุฑ ูู ุงููุฎุฒูู ุชููุงุฆูุงู
CREATE OR REPLACE FUNCTION track_stock_movement()
RETURNS TRIGGER AS $$
BEGIN
  -- ุชุณุฌูู ููุท ูู ุงููุฎุฒูู ุงุชุบูุฑ
  IF NEW.stock != OLD.stock THEN
    INSERT INTO stock_movements (
      product_id,
      quantity_change,
      reason,
      old_stock,
      new_stock,
      notes
    ) VALUES (
      NEW.id,
      NEW.stock - OLD.stock,
      'auto_tracked',
      OLD.stock,
      NEW.stock,
      'ุชู ุงูุชุบููุฑ ุชููุงุฆูุงู'
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS track_stock_trigger ON products;
CREATE TRIGGER track_stock_trigger
  AFTER UPDATE OF stock ON products
  FOR EACH ROW
  EXECUTE FUNCTION track_stock_movement();

-- ========================================
-- PART 6: Low Stock Alert View
-- ========================================

-- View ููููุชุฌุงุช ุงููู ูุฑุจุช ุชุฎูุต
CREATE OR REPLACE VIEW low_stock_products AS
SELECT 
  p.id,
  p.name,
  p.stock AS current_stock,
  p.min_stock_level,
  p.stock - p.min_stock_level AS stock_difference,
  CASE 
    WHEN p.stock = 0 THEN 'ููุฐ'
    WHEN p.stock < p.min_stock_level THEN 'ุญุฑุฌ'
    ELSE 'ุนุงุฏู'
  END AS status
FROM products p
WHERE p.stock <= p.min_stock_level
ORDER BY p.stock ASC;

-- ========================================
-- PART 7: Performance Indexes
-- ========================================

-- Indexes ููุฃุฏุงุก ุงูุนุงูู
CREATE INDEX IF NOT EXISTS idx_orders_status 
  ON orders(status);

CREATE INDEX IF NOT EXISTS idx_orders_created_at 
  ON orders(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_orders_clinic 
  ON orders(clinic_id);

CREATE INDEX IF NOT EXISTS idx_products_stock 
  ON products(stock);

CREATE INDEX IF NOT EXISTS idx_products_category 
  ON products(category_id);

-- ========================================
-- PART 8: Data Validation Functions
-- ========================================

-- ุฏุงูุฉ ููุชุญูู ูู ุตูุงุญูุฉ ุฑูู ุงููุงุชู ุงููุตุฑู
CREATE OR REPLACE FUNCTION is_valid_egyptian_phone(phone TEXT)
RETURNS BOOLEAN AS $$
BEGIN
  -- ููุจู: 01xxxxxxxxx ุฃู +201xxxxxxxxx ุฃู 00201xxxxxxxxx
  RETURN phone ~ '^(\+?20|0)?1[0125][0-9]{8}$';
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- ุฅุถุงูุฉ constraint ููุฃุฑูุงู
ALTER TABLE orders 
  DROP CONSTRAINT IF EXISTS orders_valid_phone;

-- ูููู ุชูุนููู ูุงุญูุงู ุฅุฐุง ุฃุฑุฏุช
-- ALTER TABLE orders 
--   ADD CONSTRAINT orders_valid_phone 
--   CHECK (customer_phone IS NULL OR is_valid_egyptian_phone(customer_phone));

-- ========================================
-- PART 9: Audit Log Table
-- ========================================

-- ุฌุฏูู ูุชุณุฌูู ูู ุงูุนูููุงุช ุงููููุฉ
CREATE TABLE IF NOT EXISTS audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  action TEXT NOT NULL, -- 'create', 'update', 'delete'
  table_name TEXT NOT NULL,
  record_id UUID NOT NULL,
  user_id UUID REFERENCES users(id),
  changes JSONB, -- ุงูุจูุงูุงุช ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ
  ip_address TEXT,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Index ููุจุญุซ ุงูุณุฑูุน
CREATE INDEX IF NOT EXISTS idx_audit_logs_table 
  ON audit_logs(table_name, record_id);

CREATE INDEX IF NOT EXISTS idx_audit_logs_user 
  ON audit_logs(user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_audit_logs_created 
  ON audit_logs(created_at DESC);

-- ========================================
-- PART 10: Helper Function ููู Audit
-- ========================================

CREATE OR REPLACE FUNCTION log_audit(
  p_action TEXT,
  p_table_name TEXT,
  p_record_id UUID,
  p_user_id UUID,
  p_changes JSONB DEFAULT NULL
) RETURNS UUID AS $$
DECLARE
  v_log_id UUID;
BEGIN
  INSERT INTO audit_logs (
    action,
    table_name,
    record_id,
    user_id,
    changes
  ) VALUES (
    p_action,
    p_table_name,
    p_record_id,
    p_user_id,
    p_changes
  ) RETURNING id INTO v_log_id;
  
  RETURN v_log_id;
END;
$$ LANGUAGE plpgsql;

-- ========================================
-- DONE! โ
-- ========================================

-- ุฑุณุงูุฉ ูุฌุงุญ
DO $$ 
BEGIN 
  RAISE NOTICE 'โ Migration completed successfully!';
  RAISE NOTICE '๐ Added: version control, stock management, audit logs';
  RAISE NOTICE '๐ Added: safe stock operations with locking';
  RAISE NOTICE '๐ Added: performance indexes';
END $$;