# 🔧 حل مشكلة اختفاء العيادات - دليل سريع

## المشكلة
العيادات التي يضيفها المستخدمون ذوو الصلاحيات المحدودة (مثل "mo") تختفي بعد تحديث الصفحة ولا تظهر لا للمستخدم نفسه ولا للأدمن.

## ✅ الحل السريع (5 دقائق)

### الخطوة 1️⃣: تطبيق إصلاح قاعدة البيانات

1. افتح **Supabase Dashboard**
2. اذهب إلى **SQL Editor**
3. انسخ والصق هذا الكود **بالكامل**:

```sql
-- تفعيل RLS
ALTER TABLE clinics ENABLE ROW LEVEL SECURITY;

-- حذف السياسات القديمة
DROP POLICY IF EXISTS "Service role has full access" ON clinics;
DROP POLICY IF EXISTS "Authenticated users can read all clinics" ON clinics;
DROP POLICY IF EXISTS "Authenticated users can insert clinics" ON clinics;
DROP POLICY IF EXISTS "Users can update their clinics or admins can update any" ON clinics;
DROP POLICY IF EXISTS "Only admins and managers can delete clinics" ON clinics;
DROP POLICY IF EXISTS "Enable read access for all users" ON clinics;
DROP POLICY IF EXISTS "Enable insert for authenticated users only" ON clinics;

-- إنشاء السياسات الجديدة
CREATE POLICY "Service role has full access" 
ON clinics FOR ALL TO service_role 
USING (true) WITH CHECK (true);

CREATE POLICY "Authenticated users can read all clinics" 
ON clinics FOR SELECT TO authenticated USING (true);

CREATE POLICY "Authenticated users can insert clinics" 
ON clinics FOR INSERT TO authenticated WITH CHECK (true);

CREATE POLICY "Users can update their clinics or admins can update any" 
ON clinics FOR UPDATE TO authenticated 
USING (true) WITH CHECK (true);

CREATE POLICY "Only admins and managers can delete clinics" 
ON clinics FOR DELETE TO authenticated 
USING (
    EXISTS (
        SELECT 1 FROM users 
        WHERE users.id = auth.uid()::text 
        AND users.role IN ('admin', 'manager')
    )
);
```

4. اضغط **Run** أو `Ctrl+Enter`
5. يجب أن ترى رسالة نجاح: `Success. No rows returned`

### الخطوة 2️⃣: إعادة تشغيل السيرفر

في Terminal الخاص بك:

```bash
# أوقف السيرفر بـ Ctrl+C
# ثم شغله مرة أخرى
npm run dev
```

### الخطوة 3️⃣: مسح الـ Cache واختبار الحل

1. افتح المتصفح واضغط `Ctrl + Shift + R` (Hard Refresh)
2. سجل دخول بحساب "mo"
3. أضف عيادة جديدة (تأكد من ملء المنطقة والخط)
4. حدث الصفحة `F5` أو `Ctrl + R`
5. **يجب أن تظهر العيادة الآن!** ✅

### الخطوة 4️⃣: التحقق من نجاح الحل

افتح هذا الرابط في المتصفح (وأنت مسجل دخول):
```
http://localhost:3000/api/clinics/debug
```

يجب أن ترى:
- ✅ `serviceRoleKeyPresent: true`
- ✅ `serviceRoleClinicCount` أكبر من 0
- ✅ قائمة بالعيادات في `latestClinics`

## 🔍 التشخيص التفصيلي (إذا استمرت المشكلة)

استخدم الملف: `diagnose_clinics_fixed.sql`

في Supabase SQL Editor، قم بتشغيل الأوامر واحداً تلو الآخر لمعرفة:
- حالة RLS
- السياسات الموجودة
- عدد العيادات الكلي
- العيادات التي بها مشاكل

## 🎯 النتيجة المتوقعة بعد الإصلاح

- ✅ المستخدم "mo" يستطيع إضافة عيادات
- ✅ المستخدم "mo" يرى العيادات التي أضافها بعد التحديث
- ✅ الأدمن يرى جميع العيادات بما فيها عيادات "mo"
- ✅ المستخدمون العاديون يرون فقط العيادات في منطقتهم/خطهم
- ✅ لا توجد عيادات "مختفية"

## ⚠️ ملاحظات مهمة

1. **بعد تعديل `.env.local`** يجب إعادة تشغيل السيرفر
2. **استخدم Hard Refresh** دائماً: `Ctrl + Shift + R`
3. **تأكد من ملء جميع الحقول المطلوبة**: الاسم، اسم الطبيب، المنطقة، الخط
4. **إذا ظهرت مشكلة**: تحقق من console المتصفح و terminal السيرفر

## 📝 سبب المشكلة

كانت المشكلة نتيجة لـ:
1. **سياسات RLS مقيدة جداً** - تمنع المستخدمين من رؤية البيانات
2. **الـ Cache** - يحفظ نتائج فارغة لمدة دقيقتين
3. **عمود `status` غير موجود** - كان في الكود القديم ويسبب أخطاء SQL

## 🆘 لا يزال لا يعمل؟

1. شغل: `http://localhost:3000/api/clinics/debug`
2. شغل: `diagnose_clinics_fixed.sql` في Supabase
3. تحقق من Browser Console (F12) → Console tab
4. تحقق من Terminal حيث يعمل السيرفر
5. شارك الأخطاء التي تظهر

## ✨ تحسينات تم إضافتها

- ✅ إصلاح سياسات RLS
- ✅ إزالة عمود `status` غير الموجود من الأكواد
- ✅ إضافة Cache Invalidation headers
- ✅ إضافة endpoint للتشخيص: `/api/clinics/debug`
- ✅ تحسين logging في API route
