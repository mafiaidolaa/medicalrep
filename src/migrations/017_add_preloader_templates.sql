-- =================================================\n-- إضافة دعم النماذج المتقدمة للـ Preloader\n-- Advanced Preloader Templates Support Migration\n-- =================================================\n\n-- إضافة حقل النموذج النشط\nALTER TABLE site_settings \nADD COLUMN IF NOT EXISTS preloader_active_template TEXT DEFAULT 'modern' \nCHECK (preloader_active_template IN (\n  'modern', 'glassy', 'professional', 'transparent', \n  'neon', 'elegant', 'futuristic'\n));\n\n-- تحديث الإعداد الافتراضي للنموذج النشط\nUPDATE site_settings \nSET \n    preloader_active_template = COALESCE(preloader_active_template, 'modern'),\n    updated_at = CURRENT_TIMESTAMP\nWHERE id = 1;\n\n-- إضافة تعليق للحقل الجديد\nCOMMENT ON COLUMN site_settings.preloader_active_template IS 'معرف النموذج النشط للـ Preloader من النماذج المتقدمة';\n\n-- إنشاء فهرس للنموذج النشط\nCREATE INDEX IF NOT EXISTS idx_site_settings_active_template ON site_settings(preloader_active_template);\n\n-- إنشاء دالة للتحقق من صحة النماذج\nCREATE OR REPLACE FUNCTION validate_preloader_template()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- التحقق من صحة النموذج\n    IF NEW.preloader_active_template IS NOT NULL AND \n       NEW.preloader_active_template NOT IN (\n           'modern', 'glassy', 'professional', 'transparent', \n           'neon', 'elegant', 'futuristic'\n       ) THEN\n        RAISE EXCEPTION 'النموذج المحدد غير صحيح. النماذج المتاحة: modern, glassy, professional, transparent, neon, elegant, futuristic';\n    END IF;\n    \n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- ربط الدالة بـ trigger\nDROP TRIGGER IF EXISTS validate_preloader_template_trigger ON site_settings;\nCREATE TRIGGER validate_preloader_template_trigger\n    BEFORE INSERT OR UPDATE ON site_settings\n    FOR EACH ROW\n    EXECUTE FUNCTION validate_preloader_template();\n\n-- إضافة النموذج الافتراضي إذا لم يوجد صف في الجدول\nINSERT INTO site_settings (\n    id, site_title, site_description, logo_path, icon_path, favicon_path, loading_icon_path,\n    primary_color, secondary_color, meta_keywords, meta_author, \n    company_phone, company_email, company_address, company_website, company_currency,\n    system_language, rtl_support,\n    -- إعدادات Preloader مع النموذج النشط\n    preloader_enabled, preloader_logo_size, preloader_show_logo, preloader_logo_animation,\n    preloader_loading_message, preloader_show_app_name, preloader_custom_subtitle,\n    preloader_animation_type, preloader_animation_speed, preloader_animation_color,\n    preloader_background_color, preloader_text_color, preloader_blur_background,\n    preloader_show_progress, preloader_min_display_time, preloader_fade_out_duration,\n    preloader_active_template\n) \nSELECT \n    1, 'EP Group System', 'نظام إدارة متطور للشركات والمؤسسات', \n    '/logo.svg', '/logo.png', '/favicon.ico', '/logo.svg',\n    '#0066cc', '#6c757d', 'EP Group, نظام إدارة, إدارة العيادات, إدارة المستودعات', 'EP Group',\n    '+966123456789', 'info@epgroup.com', 'الرياض، المملكة العربية السعودية', 'https://www.epgroup.com', '',\n    'ar', true,\n    -- إعدادات Preloader مع النموذج العصري كافتراضي\n    true, 100, true, true,\n    '🚀 جاري التحضير للتجربة...', true, 'تكنولوجيا متقدمة في خدمتك',\n    'wave', 'normal', '#667eea',\n    '', '', true,\n    true, 1500, 500,\n    'modern' -- النموذج الافتراضي\nWHERE NOT EXISTS (SELECT 1 FROM site_settings WHERE id = 1);\n\n-- دالة مساعدة للحصول على إعدادات النموذج النشط\nCREATE OR REPLACE FUNCTION get_active_preloader_template()\nRETURNS TEXT AS $$\nDECLARE\n    active_template TEXT;\nBEGIN\n    SELECT preloader_active_template INTO active_template\n    FROM site_settings\n    WHERE id = 1;\n    \n    RETURN COALESCE(active_template, 'modern');\nEND;\n$$ LANGUAGE plpgsql;\n\n-- دالة لتطبيق إعدادات نموذج معين\nCREATE OR REPLACE FUNCTION apply_preloader_template(template_id TEXT)\nRETURNS BOOLEAN AS $$\nBEGIN\n    -- التحقق من صحة النموذج\n    IF template_id NOT IN (\n        'modern', 'glassy', 'professional', 'transparent', \n        'neon', 'elegant', 'futuristic'\n    ) THEN\n        RAISE EXCEPTION 'النموذج المحدد غير صحيح: %', template_id;\n    END IF;\n    \n    -- تطبيق الإعدادات حسب النموذج\n    CASE template_id\n        WHEN 'modern' THEN\n            UPDATE site_settings SET\n                preloader_active_template = 'modern',\n                preloader_logo_size = 100,\n                preloader_show_logo = true,\n                preloader_logo_animation = true,\n                preloader_loading_message = '🚀 جاري التحضير للتجربة...',\n                preloader_show_app_name = true,\n                preloader_custom_subtitle = 'تكنولوجيا متقدمة في خدمتك',\n                preloader_animation_type = 'wave',\n                preloader_animation_speed = 'normal',\n                preloader_animation_color = '#667eea',\n                preloader_background_color = '',\n                preloader_text_color = '',\n                preloader_blur_background = true,\n                preloader_show_progress = true,\n                preloader_min_display_time = 1500,\n                preloader_fade_out_duration = 500,\n                updated_at = CURRENT_TIMESTAMP\n            WHERE id = 1;\n            \n        WHEN 'glassy' THEN\n            UPDATE site_settings SET\n                preloader_active_template = 'glassy',\n                preloader_logo_size = 120,\n                preloader_loading_message = '✨ جاري تجهيز التجربة الرائعة...',\n                preloader_custom_subtitle = 'شفافية تكشف الجمال',\n                preloader_animation_type = 'pulse',\n                preloader_animation_speed = 'slow',\n                preloader_animation_color = '#ffffff',\n                preloader_background_color = 'rgba(255, 255, 255, 0.05)',\n                preloader_text_color = '#ffffff',\n                preloader_blur_background = true,\n                preloader_show_progress = false,\n                preloader_min_display_time = 2000,\n                preloader_fade_out_duration = 800,\n                updated_at = CURRENT_TIMESTAMP\n            WHERE id = 1;\n            \n        WHEN 'professional' THEN\n            UPDATE site_settings SET\n                preloader_active_template = 'professional',\n                preloader_logo_size = 90,\n                preloader_logo_animation = false,\n                preloader_loading_message = 'جاري تحضير النظام...',\n                preloader_custom_subtitle = 'حلول مهنية متقدمة',\n                preloader_animation_type = 'scale',\n                preloader_animation_speed = 'normal',\n                preloader_animation_color = '#2a5298',\n                preloader_background_color = '#ffffff',\n                preloader_text_color = '#1e3c72',\n                preloader_blur_background = false,\n                preloader_show_progress = true,\n                preloader_min_display_time = 1200,\n                preloader_fade_out_duration = 300,\n                updated_at = CURRENT_TIMESTAMP\n            WHERE id = 1;\n            \n        WHEN 'transparent' THEN\n            UPDATE site_settings SET\n                preloader_active_template = 'transparent',\n                preloader_logo_size = 80,\n                preloader_loading_message = 'جاري التحميل بهدوء...',\n                preloader_show_app_name = false,\n                preloader_custom_subtitle = '',\n                preloader_animation_type = 'fade',\n                preloader_animation_speed = 'slow',\n                preloader_animation_color = 'rgba(0, 0, 0, 0.6)',\n                preloader_background_color = 'transparent',\n                preloader_text_color = 'rgba(0, 0, 0, 0.7)',\n                preloader_blur_background = false,\n                preloader_show_progress = false,\n                preloader_min_display_time = 800,\n                preloader_fade_out_duration = 1000,\n                updated_at = CURRENT_TIMESTAMP\n            WHERE id = 1;\n            \n        WHEN 'neon' THEN\n            UPDATE site_settings SET\n                preloader_active_template = 'neon',\n                preloader_logo_size = 110,\n                preloader_loading_message = '⚡ شحن الطاقة الإبداعية...',\n                preloader_custom_subtitle = 'استعد للإبهار!',\n                preloader_animation_type = 'bounce',\n                preloader_animation_speed = 'fast',\n                preloader_animation_color = '#ff006e',\n                preloader_background_color = '#0a0a0a',\n                preloader_text_color = '#ffffff',\n                preloader_blur_background = false,\n                preloader_show_progress = true,\n                preloader_min_display_time = 2000,\n                preloader_fade_out_duration = 400,\n                updated_at = CURRENT_TIMESTAMP\n            WHERE id = 1;\n            \n        WHEN 'elegant' THEN\n            UPDATE site_settings SET\n                preloader_active_template = 'elegant',\n                preloader_logo_size = 70,\n                preloader_logo_animation = false,\n                preloader_loading_message = 'تحضير المحتوى...',\n                preloader_custom_subtitle = 'بساطة تتحدث عن نفسها',\n                preloader_animation_type = 'dots',\n                preloader_animation_speed = 'normal',\n                preloader_animation_color = '#6c757d',\n                preloader_background_color = '#ffffff',\n                preloader_text_color = '#495057',\n                preloader_blur_background = false,\n                preloader_show_progress = false,\n                preloader_min_display_time = 1000,\n                preloader_fade_out_duration = 300,\n                updated_at = CURRENT_TIMESTAMP\n            WHERE id = 1;\n            \n        WHEN 'futuristic' THEN\n            UPDATE site_settings SET\n                preloader_active_template = 'futuristic',\n                preloader_logo_size = 130,\n                preloader_loading_message = '🛸 تهيئة التقنيات المتقدمة...',\n                preloader_custom_subtitle = 'مرحباً بك في المستقبل',\n                preloader_animation_type = 'progress',\n                preloader_animation_speed = 'fast',\n                preloader_animation_color = '#00d4aa',\n                preloader_background_color = '#000814',\n                preloader_text_color = '#ffffff',\n                preloader_blur_background = true,\n                preloader_show_progress = true,\n                preloader_min_display_time = 1800,\n                preloader_fade_out_duration = 600,\n                updated_at = CURRENT_TIMESTAMP\n            WHERE id = 1;\n    END CASE;\n    \n    RETURN TRUE;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- إنشاء جدول لحفظ النماذج المخصصة (اختياري)\nCREATE TABLE IF NOT EXISTS preloader_custom_templates (\n    id SERIAL PRIMARY KEY,\n    name TEXT NOT NULL,\n    description TEXT,\n    settings JSONB NOT NULL,\n    created_by INTEGER,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- إضافة تعليقات للجدول الجديد\nCOMMENT ON TABLE preloader_custom_templates IS 'جدول النماذج المخصصة للـ Preloader';\nCOMMENT ON COLUMN preloader_custom_templates.settings IS 'إعدادات النموذج بصيغة JSON';\n\n-- طباعة رسالة نجاح\nSELECT 'تم إضافة دعم النماذج المتقدمة للـ Preloader بنجاح! 🎨✨' as result;"