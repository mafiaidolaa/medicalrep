-- =================================================\n-- إضافة إعدادات Preloader المتقدم\n-- Advanced Preloader Settings Migration\n-- =================================================\n\n-- إضافة حقول إعدادات Preloader إلى جدول site_settings\nALTER TABLE site_settings \nADD COLUMN IF NOT EXISTS preloader_enabled BOOLEAN DEFAULT true,\nADD COLUMN IF NOT EXISTS preloader_logo_size INTEGER DEFAULT 80,\nADD COLUMN IF NOT EXISTS preloader_show_logo BOOLEAN DEFAULT true,\nADD COLUMN IF NOT EXISTS preloader_logo_animation BOOLEAN DEFAULT true,\nADD COLUMN IF NOT EXISTS preloader_loading_message TEXT DEFAULT 'جاري التحميل...',\nADD COLUMN IF NOT EXISTS preloader_show_app_name BOOLEAN DEFAULT true,\nADD COLUMN IF NOT EXISTS preloader_custom_subtitle TEXT DEFAULT '',\nADD COLUMN IF NOT EXISTS preloader_animation_type TEXT DEFAULT 'spin' CHECK (preloader_animation_type IN ('spin', 'pulse', 'bounce', 'dots', 'progress', 'wave', 'fade', 'scale')),\nADD COLUMN IF NOT EXISTS preloader_animation_speed TEXT DEFAULT 'normal' CHECK (preloader_animation_speed IN ('slow', 'normal', 'fast')),\nADD COLUMN IF NOT EXISTS preloader_animation_color TEXT DEFAULT '#0066cc',\nADD COLUMN IF NOT EXISTS preloader_background_color TEXT DEFAULT '',\nADD COLUMN IF NOT EXISTS preloader_text_color TEXT DEFAULT '',\nADD COLUMN IF NOT EXISTS preloader_blur_background BOOLEAN DEFAULT false,\nADD COLUMN IF NOT EXISTS preloader_show_progress BOOLEAN DEFAULT false,\nADD COLUMN IF NOT EXISTS preloader_min_display_time INTEGER DEFAULT 1000 CHECK (preloader_min_display_time >= 0 AND preloader_min_display_time <= 10000),\nADD COLUMN IF NOT EXISTS preloader_fade_out_duration INTEGER DEFAULT 300 CHECK (preloader_fade_out_duration >= 0 AND preloader_fade_out_duration <= 5000);\n\n-- تحديث الإعدادات الافتراضية للصف الموجود (إن وجد)\nUPDATE site_settings \nSET \n    preloader_enabled = COALESCE(preloader_enabled, true),\n    preloader_logo_size = COALESCE(preloader_logo_size, 80),\n    preloader_show_logo = COALESCE(preloader_show_logo, true),\n    preloader_logo_animation = COALESCE(preloader_logo_animation, true),\n    preloader_loading_message = COALESCE(preloader_loading_message, 'جاري التحميل...'),\n    preloader_show_app_name = COALESCE(preloader_show_app_name, true),\n    preloader_custom_subtitle = COALESCE(preloader_custom_subtitle, ''),\n    preloader_animation_type = COALESCE(preloader_animation_type, 'spin'),\n    preloader_animation_speed = COALESCE(preloader_animation_speed, 'normal'),\n    preloader_animation_color = COALESCE(preloader_animation_color, '#0066cc'),\n    preloader_background_color = COALESCE(preloader_background_color, ''),\n    preloader_text_color = COALESCE(preloader_text_color, ''),\n    preloader_blur_background = COALESCE(preloader_blur_background, false),\n    preloader_show_progress = COALESCE(preloader_show_progress, false),\n    preloader_min_display_time = COALESCE(preloader_min_display_time, 1000),\n    preloader_fade_out_duration = COALESCE(preloader_fade_out_duration, 300)\nWHERE id = 1;\n\n-- إنشاء فهرس لتحسين الأداء على حقل preloader_enabled\nCREATE INDEX IF NOT EXISTS idx_site_settings_preloader_enabled ON site_settings(preloader_enabled);\n\n-- إضافة تعليق على الجدول\nCOMMENT ON COLUMN site_settings.preloader_enabled IS 'تفعيل/إلغاء تفعيل شاشة التحميل الأولية';\nCOMMENT ON COLUMN site_settings.preloader_logo_size IS 'حجم الشعار في شاشة التحميل (بالبيكسل)';\nCOMMENT ON COLUMN site_settings.preloader_show_logo IS 'عرض الشعار في شاشة التحميل';\nCOMMENT ON COLUMN site_settings.preloader_logo_animation IS 'تفعيل أنيميشن الشعار';\nCOMMENT ON COLUMN site_settings.preloader_loading_message IS 'رسالة التحميل المعروضة';\nCOMMENT ON COLUMN site_settings.preloader_show_app_name IS 'عرض اسم التطبيق';\nCOMMENT ON COLUMN site_settings.preloader_custom_subtitle IS 'عنوان فرعي مخصص';\nCOMMENT ON COLUMN site_settings.preloader_animation_type IS 'نوع أنيميشن التحميل';\nCOMMENT ON COLUMN site_settings.preloader_animation_speed IS 'سرعة الأنيميشن';\nCOMMENT ON COLUMN site_settings.preloader_animation_color IS 'لون الأنيميشن';\nCOMMENT ON COLUMN site_settings.preloader_background_color IS 'لون خلفية شاشة التحميل';\nCOMMENT ON COLUMN site_settings.preloader_text_color IS 'لون النص في شاشة التحميل';\nCOMMENT ON COLUMN site_settings.preloader_blur_background IS 'تفعيل ضبابية الخلفية';\nCOMMENT ON COLUMN site_settings.preloader_show_progress IS 'عرض شريط التقدم';\nCOMMENT ON COLUMN site_settings.preloader_min_display_time IS 'أقل وقت عرض لشاشة التحميل (بالميلي ثانية)';\nCOMMENT ON COLUMN site_settings.preloader_fade_out_duration IS 'مدة الاختفاء التدريجي (بالميلي ثانية)';\n\n-- إنشاء دالة للتحقق من صحة إعدادات Preloader\nCREATE OR REPLACE FUNCTION validate_preloader_settings()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- التحقق من صحة حجم الشعار\n    IF NEW.preloader_logo_size IS NOT NULL AND (NEW.preloader_logo_size < 16 OR NEW.preloader_logo_size > 500) THEN\n        RAISE EXCEPTION 'حجم الشعار يجب أن يكون بين 16 و 500 بيكسل';\n    END IF;\n    \n    -- التحقق من صحة لون الأنيميشن\n    IF NEW.preloader_animation_color IS NOT NULL AND NEW.preloader_animation_color != '' AND NEW.preloader_animation_color !~ '^#[0-9A-Fa-f]{6}$' THEN\n        RAISE EXCEPTION 'لون الأنيميشن يجب أن يكون بصيغة hex صحيحة (#RRGGBB)';\n    END IF;\n    \n    -- التحقق من صحة لون الخلفية\n    IF NEW.preloader_background_color IS NOT NULL AND NEW.preloader_background_color != '' AND NEW.preloader_background_color !~ '^#[0-9A-Fa-f]{6}$' THEN\n        RAISE EXCEPTION 'لون الخلفية يجب أن يكون بصيغة hex صحيحة (#RRGGBB)';\n    END IF;\n    \n    -- التحقق من صحة لون النص\n    IF NEW.preloader_text_color IS NOT NULL AND NEW.preloader_text_color != '' AND NEW.preloader_text_color !~ '^#[0-9A-Fa-f]{6}$' THEN\n        RAISE EXCEPTION 'لون النص يجب أن يكون بصيغة hex صحيحة (#RRGGBB)';\n    END IF;\n    \n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- ربط الدالة بـ trigger\nDROP TRIGGER IF EXISTS validate_preloader_settings_trigger ON site_settings;\nCREATE TRIGGER validate_preloader_settings_trigger\n    BEFORE INSERT OR UPDATE ON site_settings\n    FOR EACH ROW\n    EXECUTE FUNCTION validate_preloader_settings();\n\n-- إضافة بعض القيم التجريبية إذا لم يوجد صف في الجدول\nINSERT INTO site_settings (\n    id, site_title, site_description, logo_path, icon_path, favicon_path, loading_icon_path,\n    primary_color, secondary_color, meta_keywords, meta_author, \n    company_phone, company_email, company_address, company_website, company_currency,\n    system_language, rtl_support,\n    -- إعدادات Preloader الجديدة\n    preloader_enabled, preloader_logo_size, preloader_show_logo, preloader_logo_animation,\n    preloader_loading_message, preloader_show_app_name, preloader_custom_subtitle,\n    preloader_animation_type, preloader_animation_speed, preloader_animation_color,\n    preloader_background_color, preloader_text_color, preloader_blur_background,\n    preloader_show_progress, preloader_min_display_time, preloader_fade_out_duration\n) \nSELECT \n    1, 'EP Group System', 'نظام إدارة متطور للشركات والمؤسسات', \n    '/logo.svg', '/logo.png', '/favicon.ico', '/logo.svg',\n    '#0066cc', '#6c757d', 'EP Group, نظام إدارة, إدارة العيادات, إدارة المستودعات', 'EP Group',\n    '+966123456789', 'info@epgroup.com', 'الرياض، المملكة العربية السعودية', 'https://www.epgroup.com', '',\n    'ar', true,\n    -- إعدادات Preloader الافتراضية\n    true, 80, true, true,\n    'جاري التحميل...', true, '',\n    'spin', 'normal', '#0066cc',\n    '', '', false,\n    false, 1000, 300\nWHERE NOT EXISTS (SELECT 1 FROM site_settings WHERE id = 1);\n\n-- تحديث الـ updated_at timestamp\nUPDATE site_settings SET updated_at = CURRENT_TIMESTAMP WHERE id = 1;\n\n-- طباعة رسالة نجاح\nSELECT 'تم إضافة إعدادات Preloader بنجاح! ✅' as result;