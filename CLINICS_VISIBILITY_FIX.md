# ุฅุตูุงุญ ูุดููุฉ ุธููุฑ ุงูุนูุงุฏุงุช
## Clinics Visibility Fix

---

## ๐ด ุงููุดููุฉ

### ุงูุฃุนุฑุงุถ:
1. โ **Admin** ูุง ูุฑู ุฃู ุนูุงุฏุงุช (ุตูุญุฉ ูุงุฑุบุฉ)
2. โ **mo user** ูุฑู ุนูุงุฏุฉ EPEG ููุท (ููุณุฌูุฉ ูู ูุจู ahmed)
3. โ **ahmed** ูุฑู ุนูุงุฏุฉ EPEG
4. โ **ุงูุนูุงุฏุฉ ุงูุฌุฏูุฏุฉ "mod"** ูู ุชูุญูุธ ุฃู ูู ุชุธูุฑ ุจุนุฏ ุงูุชุณุฌูู

### ุงูุณุจุจ ุงูุฌุฐุฑู:
ุงููุดููุฉ ูู **ุณูุงุณุงุช RLS** (Row Level Security) ุนูู ุฌุฏูู `clinics`:

1. **ุณูุงุณุฉ SELECT ุบูุฑ ุตุญูุญุฉ ููู Admin:**
   - Admin ูุฌุจ ุฃู ูุฑู ุฌููุน ุงูุนูุงุฏุงุช
   - ููู ุงูุณูุงุณุฉ ุงูุญุงููุฉ ุชููุนู

2. **ุณูุงุณุฉ INSERT ุบูุฑ ุตุญูุญุฉ:**
   - ุงูุนูุงุฏุงุช ุงูุฌุฏูุฏุฉ ูุง ุชูุญูุธ ุจุดูู ุตุญูุญ
   - ุฃู ุชูุญูุธ ููู ูุง ูููู ูุฑุงุกุชูุง ุจุนุฏ ุฐูู

3. **ูุดููุฉ ูุญุชููุฉ ูู auth.uid():**
   - ูุฏ ูููู ููุงู ูุดููุฉ ูู ุฑุจุท ุงููุณุชุฎุฏู ุงูุญุงูู

---

## โ ุงูุญู

### ุงูุฎุทูุฉ 1: ุชุทุจูู Fix Script

ูู **Supabase SQL Editor**ุ ุดุบูู ุงูููู:
```sql
fix_clinics_visibility.sql
```

### ูุง ุณูุญุฏุซ:

#### Part 1: ุงูุชุดุฎูุต
- โ ุนุฑุถ ุฌููุน ุงูุนูุงุฏุงุช ูู Database
- โ ุนุฑุถ ุฌููุน ุงููุณุชุฎุฏููู ูุตูุงุญูุงุชูู
- โ ูุญุต ุณูุงุณุงุช RLS ุงูุญุงููุฉ
- โ ุงูุชุญูู ูู ุชูุนูู RLS

#### Part 2: ุงูุฅุตูุงุญ
- โ ุญุฐู ุฌููุน ุณูุงุณุงุช RLS ุงููุฏููุฉ
- โ ุฅูุดุงุก 8 ุณูุงุณุงุช ุฌุฏูุฏุฉ ููุญุณููุฉ:
  * `clinics_select_admin` - Admin ูุฑู ุงููู
  * `clinics_select_gm` - GM ูุฑู ุงููู
  * `clinics_select_user_area_line` - Users ูุฑูู ููุทูุชูู/ุฎุทูู
  * `clinics_insert_admin` - Admin ูููุดุฆ ูู ุฃู ููุงู
  * `clinics_insert_user_area_line` - Users ูููุดุฆูู ูู ููุทูุชูู
  * `clinics_update_admin` - Admin ููุญุฏุซ ุงููู
  * `clinics_update_user_area_line` - Users ููุญุฏุซูู ููุทูุชูู
  * `clinics_delete_admin` - Admin/GM ููุท ูุญุฐููู

#### Part 3: ุงูุชุญูู
- โ ุนุฑุถ ุงูุณูุงุณุงุช ุงูุฌุฏูุฏุฉ
- โ ุฅุญุตุงุฆูุงุช (ุนุฏุฏ ุงูุณูุงุณุงุชุ ุนุฏุฏ ุงูุนูุงุฏุงุช)

#### Part 4: ุงุฎุชุจุงุฑุงุช
- โ ูุง ุงูุฐู ูุฑุงู Admin
- โ ูุญุต ุงูุนูุงุฏุงุช ุจุฏูู area/line
- โ ูุญุต ุงููุณุชุฎุฏููู ุจุฏูู area/line

#### Part 5: ุฅุตูุงุญ ูุดุงูู ูุญุชููุฉ
- โ ุชุญุฏูุซ ุงูุนูุงุฏุงุช ุจุฏูู area/line
- โ ุชุญุฏูุซ ุงููุณุชุฎุฏููู ุจุฏูู area/line

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุจุนุฏ ุชุทุจูู ุงูู Fix:

#### 1. ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู
```bash
# ูู Terminal
# ุงุถุบุท Ctrl+C ูุฅููุงู Dev Server
npm run dev
```

#### 2. ุณุฌู ุฏุฎูู ูู Admin
- ุงุฐูุจ ุฅูู `/clinics`
- **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูุฌุจ ุฃู ุชุฑู **ุฌููุน ุงูุนูุงุฏุงุช**
- โ EPEG (ููุณุฌูุฉ ูู ูุจู ahmed)
- โ mod (ููุณุฌูุฉ ูู ูุจู mo) - ุฅุฐุง ูุงูุช ูุญููุธุฉ
- โ ุฃู ุนูุงุฏุงุช ุฃุฎุฑู

#### 3. ุณุฌู ุฏุฎูู ูู mo
- ุงุฐูุจ ุฅูู `/clinics`
- **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูุฌุจ ุฃู ุชุฑู ุงูุนูุงุฏุงุช ูู ููุทูุชู/ุฎุทู ููุท
- โ ุฅุฐุง ูุงู mo ูู ููุณ area/line ูุน EPEGุ ูุฌุจ ุฃู ูุฑุงูุง
- โ ุฅุฐุง ูุงู mod ูู ููุณ area/lineุ ูุฌุจ ุฃู ูุฑุงูุง

#### 4. ุณุฌู ุฏุฎูู ูู ahmed
- ุงุฐูุจ ุฅูู `/clinics`
- **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูุฌุจ ุฃู ุชุฑู ุงูุนูุงุฏุงุช ูู ููุทูุชู/ุฎุทู ููุท
- โ EPEG (ุณุฌูููุง ุจููุณู)
- โ ุฃู ุนูุงุฏุงุช ุฃุฎุฑู ูู ููุณ area/line

#### 5. ุงุฎุชุจุงุฑ ุชุณุฌูู ุนูุงุฏุฉ ุฌุฏูุฏุฉ
1. ุณุฌู ุฏุฎูู ูู mo
2. ุงุฐูุจ ุฅูู `/clinics/register`
3. ุณุฌู ุนูุงุฏุฉ ุฌุฏูุฏุฉ ุจุงุณู "test-clinic"
4. ุงูุชุธุฑ ุฑุณุงูุฉ ุงููุฌุงุญ
5. ูุฌุจ ุฃู ุชูุนุงุฏ ุชูุฌููู ุฅูู `/clinics`
6. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูุฌุจ ุฃู ุชุฑู "test-clinic" ูู ุงููุงุฆูุฉ

---

## ๐ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### Scenario 1: Admin User
| ุงูุนูุงุฏุฉ | ุงูุธููุฑ |
|---------|--------|
| EPEG | โ ูุนู |
| mod | โ ูุนู |
| test-clinic | โ ูุนู |
| **ุงููุฌููุน** | **ุฌููุน ุงูุนูุงุฏุงุช** |

### Scenario 2: mo User (ููุทูุฉ: Xุ ุฎุท: Y)
| ุงูุนูุงุฏุฉ | ุงูููุทูุฉ/ุงูุฎุท | ุงูุธููุฑ |
|---------|--------------|--------|
| EPEG | X / Y | โ ูุนู |
| mod | X / Y | โ ูุนู |
| clinic-Z | A / B | โ ูุง |

### Scenario 3: ahmed User (ููุทูุฉ: Xุ ุฎุท: Y)
| ุงูุนูุงุฏุฉ | ุงูููุทูุฉ/ุงูุฎุท | ุงูุธููุฑ |
|---------|--------------|--------|
| EPEG | X / Y | โ ูุนู |
| mod | X / Y | โ ูุนู |
| clinic-Z | A / B | โ ูุง |

---

## ๐ ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

### Problem 1: Admin ูุง ูุฒุงู ูุง ูุฑู ุงูุนูุงุฏุงุช

**ุงูุญู:**
```sql
-- ูู Supabase SQL Editor
-- ุชุญูู ูู auth.uid()
SELECT auth.uid();

-- ุชุญูู ูู ุจูุงูุงุช admin user
SELECT id, username, email, role FROM users WHERE role = 'admin';

-- ุชุญูู ูู ุณูุงุณุฉ admin
SELECT * FROM pg_policies 
WHERE tablename = 'clinics' 
  AND policyname = 'clinics_select_admin';
```

### Problem 2: ุงูุนูุงุฏุงุช ุงูุฌุฏูุฏุฉ ูุง ุชูุญูุธ

**ุงูุญู:**
```sql
-- ุชุญูู ูู ุณูุงุณุงุช INSERT
SELECT policyname, cmd FROM pg_policies 
WHERE tablename = 'clinics' 
  AND cmd = 'INSERT';

-- ุฌุฑุจ ุฅูุดุงุก ุนูุงุฏุฉ ูุฏูููุง ูุงุฎุชุจุงุฑ
INSERT INTO clinics (id, name, doctor_name, address, area, line, classification, credit_status, registered_at)
VALUES (
  gen_random_uuid(),
  'Test Clinic',
  'Dr. Test',
  'Test Address',
  'ุงููุงูุฑุฉ',
  'ุงูุฎุท ุงูุฃูู',
  'A',
  'green',
  NOW()
);
```

### Problem 3: ุงูุนูุงุฏุงุช ููุฌูุฏุฉ ููู ูุง ุชุธูุฑ

**ุงูุญู:**
```bash
# 1. ุงูุณุญ cache ูู ุงููุชุตูุญ
Ctrl+Shift+Delete

# 2. ุฃุนุฏ ุชุดุบูู Dev Server
npm run dev

# 3. ุงูุชุญ ูู Incognito mode
Ctrl+Shift+N (Chrome)
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### ููู ุชุนูู ุงูุณูุงุณุงุช ุงูุฌุฏูุฏุฉุ

#### ููู Admin/GM:
```sql
-- ูุฑูู ููุญุฏุซูู ููุญุฐููู ุฌููุน ุงูุนูุงุฏุงุช
EXISTS (
  SELECT 1 FROM users
  WHERE users.id = auth.uid()
  AND users.role IN ('admin', 'gm')
  AND users.is_active = true
)
```

#### ููู Regular Users:
```sql
-- ูุฑูู ููุญุฏุซูู ุนูุงุฏุงุช ููุทูุชูู/ุฎุทูู ููุท
EXISTS (
  SELECT 1 FROM users
  WHERE users.id = auth.uid()
  AND users.is_active = true
  AND users.area = clinics.area
  AND users.line = clinics.line
)
```

### ููุงุฐุง ุณูุงุณุชุงู ูููุตูุชุงู ููู SELECTุ

ุจุฏูุงู ูู ุณูุงุณุฉ ูุงุญุฏุฉ ูุนูุฏุฉุ ุงุณุชุฎุฏููุง:
1. `clinics_select_admin` - ููู Admin
2. `clinics_select_gm` - ููู GM
3. `clinics_select_user_area_line` - ููู Users

ูุฐุง ูุฌุนู:
- โ ุงูููุฏ ุฃุณูู ูููุฑุงุกุฉ
- โ ุงูุฃุฎุทุงุก ุฃุณูู ููุชุดุฎูุต
- โ ุงูุฃุฏุงุก ุฃูุถู (PostgreSQL ููุญุณูู ูู ุณูุงุณุฉ ุจุดูู ูููุตู)

---

## โ Checklist

ูุจู ุงูุงูุชูุงู ูููุฑุญูุฉ ุงูุชุงููุฉ:

### Database โ
- [ ] ุชุทุจูู `fix_clinics_visibility.sql`
- [ ] ุฌููุน ุงูุงุฎุชุจุงุฑุงุช PASSED
- [ ] 8 ุณูุงุณุงุช RLS ููุฌูุฏุฉ
- [ ] ูุง ุชูุฌุฏ ุนูุงุฏุงุช ุจุฏูู area/line
- [ ] ูุง ููุฌุฏ users ุจุฏูู area/line

### Frontend โ
- [ ] ุฃุนุฏุช ุชุดุบูู Dev Server
- [ ] Admin ูุฑู ุฌููุน ุงูุนูุงุฏุงุช
- [ ] mo ูุฑู ุนูุงุฏุงุช ููุทูุชู/ุฎุทู
- [ ] ahmed ูุฑู ุนูุงุฏุงุช ููุทูุชู/ุฎุทู
- [ ] ูููู ุชุณุฌูู ุนูุงุฏุงุช ุฌุฏูุฏุฉ
- [ ] ุงูุนูุงุฏุงุช ุงูุฌุฏูุฏุฉ ุชุธูุฑ ููุฑูุง

### Testing โ
- [ ] ุงุฎุชุจุงุฑ ูู Admin
- [ ] ุงุฎุชุจุงุฑ ูู mo
- [ ] ุงุฎุชุจุงุฑ ูู ahmed
- [ ] ุงุฎุชุจุงุฑ ุชุณุฌูู ุนูุงุฏุฉ ุฌุฏูุฏุฉ
- [ ] ุงุฎุชุจุงุฑ ุงูุญุฐู (Admin only)

---

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุจุนุฏ ุงูุชุฃูุฏ ูู ูุฌุงุญ ุงูุฅุตูุงุญ:

1. **ุงุฎุชุจุฑ ุจููุฉ ุงููุธุงุฆู:**
   - Orders
   - Visits
   - Collections
   - Plans

2. **ุฑุงุฌุน ุงูุชูุฑูุฑ ุงูุดุงูู:**
   - `SYSTEM_AUDIT_REPORT_AR.md`

3. **ุชุงุจุน ุงูู Pre-Production Checklist:**
   - `IMPLEMENTATION_GUIDE.md`

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2025-01-01
**ุงูุญุงูุฉ:** ๐ข ุฌุงูุฒ ููุชุทุจูู
**ุงููุฏุฉ ุงููุชููุนุฉ:** 5-10 ุฏูุงุฆู
